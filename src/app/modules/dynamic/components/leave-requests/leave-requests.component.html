<div class="mt-3 mb-4">
  <div class="onboard-add row align-items-center mx-0">
      <div class="col-md-12 p-0">
          <div class="row justify-content-between align-items-center mx-0">
              <div class="col-lg-12 col-md-12 col-sm-12 ps-0">
                  <div class="d-flex justify-content-start align-items-center">
                      <div class="empFilerDropfilter dropdown">
                          <button type="button" id="statusDropdown" class="btn btn-secondary new-deopdown d-flex align-items-center justify-content-between" (click)="changeShowFilter(true)">
                              Filters
                              <svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" viewBox="0 0 23 23" fill="none">
                                  <mask id="mask0_7808_40" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="23" height="23">
                                  <rect x="0.262695" y="0.283112" width="22.4338" height="22.4338" fill="#1C1B1F"/>
                                  </mask>
                                  <g mask="url(#mask0_7808_40)">
                                  <path d="M9.61057 17.1084V15.239H13.3495V17.1084H9.61057ZM5.87161 12.4347V10.5653H17.0885V12.4347H5.87161ZM3.06738 7.76104V5.89156H19.8927V7.76104H3.06738Z" fill="#1C1B1F"/>
                                  </g>
                                  </svg>
                          </button>


                      </div>
                      <div
                          class="onboarding-date d-flex align-items-center justify-content-between position-relative w-100">
                          <form novalidate
                              class="searching d-flex align-items-center justify-content-between w-100">
                              <div class="form-group w-100 position-relative">
                                  <input type="text" name="search" id="searchInput" #searchInput="ngModel" placeholder="Search by name.."
                                   class="form-control me-2 w-100" style="padding: 10px 45px;"  [(ngModel)]="searchTerm"
                                   (keyup)="searchTermChanged($event)" />
                                  <i class="bi bi-search search-icon d-flex align-items-center  h-100" *ngIf="searchTerm == ''"></i>
                                  <i class="bi bi-x-lg search-icon d-flex align-items-center  h-100" *ngIf="searchTerm != ''"
                                  (click)="resetFiltersSearch()"></i>

                              </div>
                          </form>
                      </div>

                  </div>

                  <div class="actionMenuList filter-box p-0 position-absolute bg-white border" [ngClass]="{'d-none': !showFilter}">
                      <div class="d-flex align-items-center justify-content-between border-bottom p-3">
                          <h5 class="mb-0 font-14 fw-semibold"> Filter</h5>
                          <span class="pointer" (click)="changeShowFilter(false)">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewBox="0 0 18 19" fill="none">
                              <g opacity="0.8">
                              <mask id="mask0_7729_258" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="18" height="19">
                              <rect y="0.5" width="18" height="18" fill="#D9D9D9"/>
                              </mask>
                              <g mask="url(#mask0_7729_258)">
                              <path d="M4.8 14.75L3.75 13.7L7.95 9.5L3.75 5.3L4.8 4.25L9 8.45L13.2 4.25L14.25 5.3L10.05 9.5L14.25 13.7L13.2 14.75L9 10.55L4.8 14.75Z" fill="#1C1B1F"/>
                              </g>
                              </g>
                              </svg>
                          </span>
                      </div>
                      <div class="row p-3">

                          <h5 class="font-14 mb-3">Date Range</h5>
                          <div class="col-md-6 mb-3">
                              <label for="from" class="pb-2">From  </label>
                              <nz-date-picker [(ngModel)]="filters.fromDate" nzBorderless
                              [nzDisabledDate]="disabledDateFrom" nzplaceholder="dd/mm/yyyy"></nz-date-picker>
                          </div>
                          <div class="col-md-6 mb-3">
                              <label for="to" class="pb-2">To  </label>
                              <nz-date-picker [(ngModel)]="filters.toDate"[(ngModel)]="filters.toDate" nzBorderless
                              [nzDisabledDate]="disabledDateTo" nzplaceholder="dd/mm/yyyy"></nz-date-picker>
                          </div>

                          <div class="col-md-12 mb-3">
                              <label for="type" class="pb-2">Leave Type</label>
                              <nz-select [(ngModel)]="filters.leaveType" nzMode="multiple"  class="w-100 form-multiselect" nzPlaceHolder="Please select">
                                  <nz-option *ngFor="let type of leaveTypes" [nzValue]="type" nzLabel="{{ type | titlecase }}"></nz-option>

                                </nz-select>
                          </div>
                          <div class="col-md-12 mb-3">
                              <label for="status" class="pb-2">Status</label>
                              <nz-select [(ngModel)]="filters.status" nzMode="multiple" class="w-100 form-multiselect" nzPlaceHolder="Please select">
                                  <nz-option *ngFor="let stat of statusMaster" [nzValue]="stat" nzLabel="{{ stat | titlecase }}"></nz-option>
                              </nz-select>
                          </div>
                      </div>
                      <div class="p-3 border-top d-flex gap-2 align-items-center justify-content-end">
                          <button class="btn cancel-btn mt-0" (click)="resetFilters()">Reset it</button>
                          <button class="btn submitActionBtn" (click)="applyFilters()">Apply</button>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <div class="filter-bdg d-flex align-items-center gap-2 mt-3" *ngIf="appliedFilters.length>0">
      <p *ngFor="let filter of appliedFilters" class="filter-pills d-flex align-items-center gap-2 pointer font-12 fw-semibold">
          {{filter.key  | titlecase}} : {{ filter.value  | titlecase}}
          <i class="bi bi-x-lg pointer" (click)="removeFilter(filter)"></i>
        </p>

    </div>

  <div class="table-responsive bg-white mt-3 employee-table">
      <table class="table" >
         <thead class="thead-light">
            <tr>
               <th class="text-left font-13" style="width: 10%;">Employee Name</th>
               <th class="text-left font-13" style="width: 15%;">Type</th>
               <th class="text-left font-13" style="width: 15%;">Date</th>
               <th class="text-left font-13" style="width: 10%;">Requested To</th>
               <th class="text-left font-13" style="width: 10%;">Status</th>
               <th class="text-left font-13" style="width: 15%;">Leave Note</th>
               <th class="text-left font-13" style="width: 15%;">Cancellation Reason</th>

               <th class="text-end font-13 stickyColTdend" style="width: 10%;">Action </th>
            </tr>
         </thead>
         <!-- TO DO: Shimmer Loading Ui -->
         <tbody *ngIf="isLoadingLeaves">
             <tr *ngFor="let item of [].constructor(10)">
                 <td>
                     <ngx-shimmer-loading [width]="'100%'" [height]="'10px'"></ngx-shimmer-loading>
                 </td>
                 <td>
                     <ngx-shimmer-loading [width]="'100%'" [height]="'10px'"></ngx-shimmer-loading>
                 </td>
                 <td>
                     <ngx-shimmer-loading [width]="'100%'" [height]="'10px'"></ngx-shimmer-loading>
                 </td>
                 <td>
                     <ngx-shimmer-loading [width]="'100%'" [height]="'10px'"></ngx-shimmer-loading>
                 </td>
                 <td>
                     <ngx-shimmer-loading [width]="'100%'" [height]="'10px'"></ngx-shimmer-loading>
                 </td>
                 <td>
                     <ngx-shimmer-loading [width]="'100%'" [height]="'10px'"></ngx-shimmer-loading>
                 </td>
                 <td>
                     <ngx-shimmer-loading [width]="'100%'" [height]="'10px'"></ngx-shimmer-loading>
                 </td>
                 <td>
                     <ngx-shimmer-loading [width]="'100%'" [height]="'10px'"></ngx-shimmer-loading>
                 </td>
             </tr>
         </tbody>
         <!-- Shimmer Loading Ui End-->

         <!-- TO DO: empty notification  -->
         <tbody *ngIf="leaves.length == 0 && !isLoadingLeaves">
             <tr>
               <td colspan="8">
                 <div class="empty-file" style="margin-top: 5%; margin-bottom: 5%">
                   <nz-empty nzNotFoundImage="assets/images/no-data-found-img.svg"
                     [nzNotFoundContent]="contentTpl">
                     <ng-template #contentTpl>
                       <p class="mb-1 empty-detail font-16">
                         No data for now
                       </p>
                     </ng-template>
                   </nz-empty>
                 </div>
               </td>
             </tr>
           </tbody>
            <!-- empty notification end -->
         <tbody class="ng-star-inserted" *ngIf="leaves.length > 0 && !isLoadingLeaves">
          <ng-container *ngFor="let leave of leaves;
          let i = index
        ">
          <tr >
              <td class="text-left font-13 fw-semibold"><span (click)="routeToUserDetails(leave.uuid)" class="team-maneger mb-0 pointer">{{leave.username}} </span></td>
               <td class="text-left">
                  <p class="mb-1 font-13 fw-semibold">{{ leave.leaveType }}</p>
                  <span class="mb-0 fw-normal font-12">on {{ leave.leaveDate | date : "dd-MM-yyyy" || "N/A" }}</span>
              </td>
               <td class="text-left">
                  <span class="team-maneger mb-0 fw-semibold font-13 "> Start Date - <span class="fw-normal"> {{ leave.startDate | date : 'dd-MM-yyyy' || "N/A" }}</span> <br>
                    Ending Date -  <span class="fw-normal">{{ leave.endDate | date : 'dd-MM-yyyy' || "N/A" }} </span>
                  </span>
               </td>
               <td class="text-left"><span class=" mb-0 font-13 fw-semibold">{{leave.managerName}} </span></td>

               <td class="text-left">
                <div class="d-flex align-items-center gap-2">
                   <span class="font-13 fw-semibold" [ngClass]="{
                        'text-danger': leave.status == REJECTED,
                        'text-primary': leave.status == PENDING || leave.status == REQUESTED,
                        'text-success': leave.status == APPROVED
                    }">{{leave.status|  uppercase}} </span>

                </div>
                <p class="mb-0 mt-0 fw-normal font-13 color-basic">By: {{leave.actionByName || '-'}} </p>
            </td>
               <td>
                  <span class="team-maneger mb-0 table-font-weight white-space fw-normal"  nzPopoverTitle="Title" nzPopoverContent="Content">{{leave.notes}}</span>
               </td>
               <td>
                  <span class="team-maneger mb-0 table-font-weight white-space fw-normal" nzPopoverTitle="Title" nzPopoverContent="Content">{{leave.rejectionReason || "N/A"}}</span>
              </td>

               <td class="text-end stickyColTdend">
                  <div class="d-flex align-items-center justify-content-end gap-2">
                      <span *ngIf="!isExpanded(i)"
                      class="btnAction d-flex align-items-center justify-content-center"
                      (click)="toggleCollapse(i); openCloseMonthCalender(); getDayWiseLeaveStatus(leave)">
                      <i class="bi bi-calendar-week font-15"></i>
                      </span>
                      <span *ngIf="isExpanded(i)"
                      class="btnAction staff-month-sheet d-flex align-items-center justify-content-center"
                      (click)="toggleCollapse(i); openCloseMonthCalender()">
                      <i class="bi bi-calendar-week font-15"></i>
                      </span>
                      <div class="dropdown">
                        <span class="btnAction d-flex align-items-center justify-content-center pointer" type="button" data-bs-toggle="dropdown">
                          <!-- Show loading spinner if the leave is being processed -->
                          <ng-container *ngIf="leaveRequestLoading[leave.id]; else showDots">
                            <div class="spinner-border spinner-border-sm" role="status">
                              <span class="visually-hidden">Loading...</span>
                            </div>
                          </ng-container>
                          <!-- Show three dots SVG when not loading -->
                          <ng-template #showDots>
                            <i class="bi bi-three-dots-vertical font-15"></i>
                          </ng-template>
                        </span>
                        <div class="dropdown-menu actionMenuList">
                          <li  *ngIf="this.rbacService.showLeaveActionButton(leave,logInUserUuid,PENDING,Routes.LEAVEMANAGEMENT)">
                            <span (click)="approveOrRejectLeave(leave.id, APPROVED)">
                              <a class="dropdown-item">
                                <i class="bi bi-check2"></i>
                                Approve
                              </a>
                            </span>
                          </li>
                          <li *ngIf="this.rbacService.showLeaveActionButton(leave,logInUserUuid,PENDING,Routes.LEAVEMANAGEMENT)">
                            <span (click)="approveOrRejectLeave(leave.id, REJECTED)">
                              <a class="dropdown-item">
                                <i class="bi bi-x"></i>
                                Reject
                              </a>
                            </span>
                          </li>
                          <li>
                            <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#leave-request" (click)="viewLeave(leave)">
                              <i class="bi bi-eye"></i>
                              View request
                            </a>
                          </li>
                        </div>
                      </div>
                  </div>
               </td>
            </tr>

            <tr class="collapse" [id]="'collapseExamplesheet' + i" [ngClass]="{'show': isExpanded(i)}">
              <td colspan="9" class="p-1">
                 <div class="month-deta">
                    <table class="table table-bordesick-leaves day-data mb-0" *ngIf="dayWiseLeaveStatusLoader">
                      <tr class="position-relative">
                          <th>
                              <div class="p-0">
                                <ngx-shimmer-loading [width]="'100%'" [height]="'30px'"></ngx-shimmer-loading>
                                <br>
                                <ngx-shimmer-loading [width]="'100%'" [height]="'30px'"></ngx-shimmer-loading>
                              </div>
                          </th>
                      </tr>

                    </table>
                    <table class="table table-bordesick-leaves day-data mb-0" *ngIf="!dayWiseLeaveStatusLoader">
                       <tr class="position-relative">
                          <ng-container *ngFor="
                          let dayWiseStatus of dayWiseLeaveStatus
                        ">
                        <th class="text-center">
                          {{
                          getDayNameFromDate(
                          dayWiseStatus.date
                          )[0]
                          }}
                          <br />
                          {{
                          getDayFromDate(dayWiseStatus.date)
                          }}
                        </th>
                         </ng-container>
                       </tr>
                       <tr class="position-relative">
                          <ng-container *ngFor="
                              let dayWiseStatus of dayWiseLeaveStatus
                              ">
                              <td class="text-center position-relative attendance-detail" [ngClass]="{
                                  'text-success':
                                  dayWiseStatus.status?.includes('Leave') ||  dayWiseStatus.status == 'LWP' ||
                                  dayWiseStatus.status == 'Half-D',
                                  'text-danger':
                                  dayWiseStatus.status == 'Reject',
                                  'text-warning':
                                  dayWiseStatus.status == 'Apply',
                                  'text-primary':
                                  dayWiseStatus.status == 'W-off' ||
                                  dayWiseStatus.status == HOLIDAY
                              }"
                              [style.backgroundColor]="isBetweenStartAndEndDate(dayWiseStatus.date) ? '#EFEFEF' : 'inherit'">
                              {{
                              dayWiseStatus.status[0] == "U"
                              ? "-"
                              : dayWiseStatus.status
                              }}
                              </td>
                          </ng-container>
                       </tr>

                    </table>
                 </div>
              </td>
           </tr>
          </ng-container>

            <div
            class="d-flex align-items-center justify-content-between pagination-box w-100 p-3 bg-white border-top"
            *ngIf="!isLoadingLeaves && leaves.length > 0 && totalItems >itemPerPage">
            <p class="mb-0 p-0">
              Showing {{ (currentPage - 1) * itemPerPage + 1 }} -
              {{ ((currentPage - 1) * itemPerPage + 1)+(leaves.length-1) }} of {{ totalItems}} Leaves
            </p>
            <div class="pagition-box p-0">
              <ngb-pagination [collectionSize]="totalItems" [(page)]="currentPage" [pageSize]="itemPerPage"
                [maxSize]="5" [boundaryLinks]="true" [ellipses]="true"
                (pageChange)="onPageChange($event)">
              </ngb-pagination>
            </div>
          </div>

         </tbody>
      </table>
   </div>
</div>

<button type="button" class="btn btn-primary d-none" data-bs-toggle="modal" data-bs-target="#leave-request">
  Leave Request
</button>
<div class="modal fade" id="leave-request" tabindex="-1" role="dialog" aria-hidden="true"  data-bs-backdrop="static" data-bs-keyboard="false"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"  [ngStyle]="{'max-width: 700px': !leave?.attachment,'max-width: 1060px': leave?.attachment}" role="document">
    <div *ngIf="isModalOpen" class="modal-content">
    <app-leave-request
    [data]="leaveData"
    (closeModal)="closeModalHandler($event)"
  ></app-leave-request>
</div>
  </div>
</div>

<div *ngIf="showLeaveQuotaModal" class="modal-overlay">
  <div class="modal-container p-0 border-rounded-2">
    <div class="modal-header mb-0">
      <h5 class="mb-0">User Leave Quota Information</h5>
      <button class="close-btn font-24" (click)="closeLeaveQuotaModal()">&times;</button>
    </div>

    <div class="modal-body">
      <div class="info-message border-rounded-2">
        <p class="mb-0">
            🚫 <strong>Note:</strong> The leave quota for <strong>{{userLeaveQuota.category}}</strong> has been fully utilized by the user.
            You can only <strong>reject</strong> this leave request.
        </p>
      </div>
      <div class="quota-details">
        <div class="detail-item border-rounded-2 d-flex alig-items-cennter justify-content-between">
          <span class="label font-13 fw-600 color-basic">👤 User Name:</span>
          <span class="font-13">{{ userLeaveQuota?.userName }}</span>
        </div>
        <div class="detail-item border-rounded-2  d-flex alig-items-cennter justify-content-between">
          <span class="label font-13 fw-600 color-basic">📅 Total Leaves:</span>
          <span class="font-13">{{ userLeaveQuota?.totalAllocatedLeaves }}</span>
        </div>
        <div class="detail-item border-rounded-2 d-flex alig-items-cennter justify-content-between">
          <span class="label  font-13 fw-600 color-basic">✅ Approved Leaves:</span>
          <span class="font-13">{{ userLeaveQuota?.approvedLeaves }}</span>
        </div>
        <div class="detail-item border-rounded-2 d-flex alig-items-cennter justify-content-between">
          <span class="label font-13 fw-600 color-basic">❌ Rejected Leaves:</span>
          <span class="font-13">{{ userLeaveQuota?.rejectedLeaves }}</span>
        </div>
        <div class="detail-item border-rounded-2 d-flex alig-items-cennter justify-content-between">
          <span class="label font-13 fw-600 color-basic">🕒 Remaining Leaves:</span>
          <span class="font-13">{{ userLeaveQuota?.remainingLeaves }}</span>
        </div>
      </div>
    </div>

    <div class="modal-footer border-top mt-0">
      <button class="btn cancel-btn font-13 fw-semibold mt-0" (click)="closeLeaveQuotaModal()">Cancel</button>
    </div>
  </div>
</div>